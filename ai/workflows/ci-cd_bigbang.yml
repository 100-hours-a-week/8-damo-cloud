name: AI Pipeline CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

permissions:
  id-token: write
  contents: read

env:
  HOST: ${{ secrets.AI_PROD_SERVER_HOST }}
  USER: ${{ secrets.AI_PROD_SERVER_USER }}
  PORT: ${{ secrets.AI_PROD_SERVER_PORT }}
  KEY: ${{ secrets.AI_PROD_SERVER_KEY }}

  REMOTE_DIR: /home/ubuntu/opt/ai-prod
  INCOMING_DIR: /home/ubuntu/opt/ai-prod/incoming

  ARTIFACT_FILE: ai-app.tar.gz
  DEPLOY_SCRIPT: scripts/deploy_bigbang.sh

  AWS_DEPLOY_ROLE_ARN: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
  DEPLOY_BUCKET: ${{ secrets.DEPLOY_BUCKET }}
  CODEDEPLOY_APP_NAME: damo-ai

  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
  MONGODB_URI: ${{ secrets.MONGODB_URI }}
  DB_NAME: ${{ secrets.DB_NAME }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
  LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
  LANGFUSE_BASE_URL: ${{ secrets.LANGFUSE_BASE_URL }}

jobs:
  ci:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12.3'

    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        poetry install

    - name: Run Integration Tests
      run: |
        # run.test.shÎ•º ÌôúÏö©ÌïòÍ±∞ÎÇò ÏßÅÏ†ë pytest Ïã§Ìñâ
        chmod +x run.test.sh 
        ./run.test.sh
    
    - name: Build tar.gz
      if: github.event_name == 'push' && (github.ref_name == 'dev' || github.ref_name == 'main')
      run: |
        set -euo pipefail

        rm -f "${{ env.ARTIFACT_FILE }}"
        
        tar -czf "${{ env.ARTIFACT_FILE }}" \
          ecosystem.ai.config.js \
          src \
          main.py \
          requirements.txt \
          run.prod.sh \
          run.dev.sh \
          run.test.sh \
          pyproject.toml

    - name: Build CodeDeploy revision (zip)
      if: github.event_name == 'push' && (github.ref_name == 'dev' || github.ref_name == 'main')
      run: |
        set -euo pipefail

        rm -rf revision
        mkdir -p revision/cd-hooks

        cp codedeploy/appspec.yml revision/appspec.yml
        cp "${{ env.ARTIFACT_FILE }}" revision/ai-app.tar.gz

        cp codedeploy/cd-hooks/after_install.sh revision/cd-hooks/after_install.sh
        chmod +x revision/cd-hooks/after_install.sh

        if [ -f codedeploy/cd-hooks/validate.sh ]; then
          cp codedeploy/cd-hooks/validate.sh revision/cd-hooks/validate.sh
          chmod +x revision/cd-hooks/validate.sh
        fi

        (cd revision && zip -r ../revision.zip .)

    # CodeDeployÏö© revision.zipÏùÑ job Í∞Ñ Ï†ÑÎã¨ÌïòÍ∏∞ ÏúÑÌïú artifact ÏóÖÎ°úÎìú
    - name: Upload revision artifact
      if: github.event_name == 'push' && (github.ref_name == 'dev' || github.ref_name == 'main')
      uses: actions/upload-artifact@v4
      with:
        name: revision-zip
        path: revision.zip
        retention-days: 3


  deploy:
    needs: ci
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref_name == 'dev' || github.ref_name == 'main') && needs.ci.result == 'success'

    steps:
      # ci jobÏóêÏÑú ÎßåÎì† revision.zip Î∞õÏïÑÏò§Í∏∞
      - name: Download revision artifact
        uses: actions/download-artifact@v4
        with:
          name: revision-zip
          path: .

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ap-northeast-2

      - name: Upload revision to S3
        run: |
          set -euo pipefail
          S3_KEY="codedeploy/dev/ai/revision-${{ github.sha }}.zip"
          aws s3 cp revision.zip "s3://${{ env.DEPLOY_BUCKET }}/$S3_KEY"
          echo "S3_KEY=$S3_KEY" >> $GITHUB_ENV

      - name: Create CodeDeploy deployment
        run: |
          set -euo pipefail

          # Î∏åÎûúÏπòÏóê Îî∞Îùº Î∞∞Ìè¨Í∑∏Î£π Î∂ÑÍ∏∞
          if [ "${{ github.ref_name }}" = "main" ]; then
            DG="prod-damo-ai"
          else
            DG="dev-damo-ai"
          fi

          # create-deploymentÎäî "ÏöîÏ≤≠"Îßå Î≥¥ÎÇ¥Í≥† Ï¶âÏãú ÎÅùÎÇòÎØÄÎ°ú,
          # deploymentIdÎ•º Î∞õÏïÑÏÑú Îã§Ïùå Ïä§ÌÖùÏóêÏÑú Ïã§Ï†ú Î∞∞Ìè¨ ÏôÑÎ£åÎ•º Í∏∞Îã§Î¶¨Í≤å ÌïúÎã§.
          DEPLOYMENT_ID="$(aws deploy create-deployment \
            --application-name "${{ env.CODEDEPLOY_APP_NAME }}" \
            --deployment-group-name "$DG" \
            --s3-location bucket="${{ env.DEPLOY_BUCKET }}",key="$S3_KEY",bundleType=zip \
            --query 'deploymentId' --output text)"

          echo "DEPLOYMENT_ID=$DEPLOYMENT_ID" >> $GITHUB_ENV
          echo "Created deployment: $DEPLOYMENT_ID"

      - name: Wait for CodeDeploy deployment to succeed
        run: |
          set -euo pipefail

          # ÏµúÎåÄ ÎåÄÍ∏∞ ÏãúÍ∞Ñ(Ï¥à)
          TIMEOUT_SECONDS=120
          INTERVAL_SECONDS=10

          start_ts="$(date +%s)"

          while true; do
            status="$(aws deploy get-deployment \
              --deployment-id "$DEPLOYMENT_ID" \
              --query 'deploymentInfo.status' \
              --output text)"

            echo "CodeDeploy status: $status"

            case "$status" in
              Succeeded)
                echo "CodeDeploy deployment succeeded: $DEPLOYMENT_ID"
                exit 0
                ;;
              Failed|Stopped)
                # Ïã§Ìå® ÏõêÏù∏ Î©îÏãúÏßÄ
                err_msg="$(aws deploy get-deployment \
                  --deployment-id "$DEPLOYMENT_ID" \
                  --query 'deploymentInfo.errorInformation.message' \
                  --output text || true)"
                echo "CodeDeploy deployment $status: $DEPLOYMENT_ID"
                echo "Error message: ${err_msg:-N/A}"
                exit 1
                ;;
              *)
                now_ts="$(date +%s)"
                elapsed="$((now_ts - start_ts))"
                if [ "$elapsed" -ge "$TIMEOUT_SECONDS" ]; then
                  echo "Timeout waiting for CodeDeploy. deploymentId=$DEPLOYMENT_ID, lastStatus=$status"
                  exit 1
                fi
                sleep "$INTERVAL_SECONDS"
                ;;
            esac
          done


  notify:
    name: Notify Discord
    runs-on: ubuntu-latest
    needs: [ci, deploy]
    if: always() && github.event_name == 'push' && (github.ref_name == 'main' || github.ref_name == 'dev')

    steps:
      - name: Send notification
        run: |
          CI_RESULT="${{ needs.ci.result }}"
          DEPLOY_RESULT="${{ needs.deploy.result }}"
          REF="${{ github.repository }}@${{ github.ref_name }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -H "Content-Type: application/json" \
                -X POST \
              -d "{\"username\":\"AI CI/CD\",\"content\":\"üñ•Ô∏è AI CI/CD Í≤∞Í≥º\\n- CI: **${CI_RESULT}**\\n- Deploy: **${DEPLOY_RESULT}**\\nüîó [${REF}](${RUN_URL})\"}" \
              ${{ secrets.DISCORD_WEBHOOK_URL }}
