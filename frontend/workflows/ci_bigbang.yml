# .github/workflows/frontend-ci.yml

name: Frontend CI

on:
  pull_request:
    branches: [main, develop] # PR ë°œìƒ ì‹œ CI íŠ¸ë¦¬ê±°
  push:
    branches: [main, develop]
jobs:
  frontend-ci:
    runs-on: ubuntu-latest # Node.js í™˜ê²½ ì œê³µ

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Node.js ì„¤ì¹˜
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜ (CI ìºì‹œ ìµœì í™”ëœ npm ci ì‚¬ìš©)
      - name: Install dependencies
        run: npm ci

      # 4. (ì„ íƒ) í¬ë§· ê²€ì¦ - Prettier ì“°ëŠ” ê²½ìš°
      - name: Check formatting (Prettier)
        run: npm run format:check

      # 5. LintëŠ” ë¹Œë“œ ì „ì—
      - name: Run Lint (ESLint)
        run: npm run lint

      # 6. ìœ ë‹› í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (Jest ê¸°ë°˜) - ë‚˜ì¤‘ì— test ì§„í–‰í•  ë•Œ
      #      - name: Run Unit Tests (Jest)
      #        run: npm run test

      # 7. ì•± ë¹Œë“œ (.next ë””ë ‰í† ë¦¬ ìƒì„±)
      - name: Build Next.js App
        run: npm run build

      # 8. SSR ë°°í¬ìš© íŒ¨í‚¤ì§• (Next standalone ê¸°ì¤€)
      - name: Package Next.js standalone bundle
        run: |
          rm -rf deploy_fe
          mkdir -p deploy_fe

          # standalone ì„œë²„ ì‹¤í–‰ íŒŒì¼ + í•„ìš”í•œ node_modules í¬í•¨
          cp -r .next/standalone/* deploy_fe/

          # ì •ì  íŒŒì¼(í•„ìˆ˜)
          mkdir -p deploy_fe/.next
          cp -r .next/static deploy_fe/.next/static

          # public (ì‚¬ìš©í•˜ë©´ í•„ìˆ˜)
          if [ -d "public" ]; then
            cp -r public deploy_fe/public
          fi

          # ëŸ°íƒ€ì„ì—ì„œ í•„ìš”í•˜ë©´ í¬í•¨
          cp package.json deploy_fe/package.json

          tar -czf next-standalone.tar.gz -C deploy_fe .

      # 9. Retention
      - name: Decide artifact retention days
        id: retention
        run: |
          if [[ "${{ github.base_ref }}" == "main" ]]; then
            echo "days=30" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.base_ref }}" == "develop" ]]; then
            echo "days=14" >> "$GITHUB_OUTPUT"
          fi

      # 10. ë¹Œë“œ ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (tar.gz)
      - name: Upload Next.js Deploy Artifact (tar.gz)
        uses: actions/upload-artifact@v4
        with:
          name: next-standalone
          path: next-standalone.tar.gz
          retention-days: ${{ steps.retention.outputs.days }}

      # 11. Discord ì•Œë¦¼ ì „ì†¡ (ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰ë¨)
      - name: Notify Discord
        if: always()
        run: |
          STATUS="${{ job.status }}"  # success / failure
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"username\": \"Frontend CI\", \"content\": \"ğŸ–¥ï¸ Frontend CI ê²°ê³¼: **${STATUS}**\nğŸ”— [${{ github.repository }}@${{ github.ref_name }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\"}" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}