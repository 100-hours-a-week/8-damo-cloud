name: Frontend CI/CD

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

env:
  NODE_VERSION: "20"
  REMOTE_DIR: /home/ubuntu/opt/fe-prod
  ARTIFACT_FILE: next-standalone.tar.gz

jobs:
  ci:
    name: CI (format/lint/build)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check formatting (Prettier)
        run: npm run format:check

      - name: Run Lint (ESLint)
        run: npm run lint

      # í…ŒìŠ¤íŠ¸ ë„ì… ì „ì´ë©´ ì£¼ì„ ìœ ì§€ ì¶”í›„ ë„ì…
      # - name: Run Unit Tests
      #   run: npm run test

      - name: Build Next.js App
        run: npm run build

      - name: Package Next.js standalone bundle
        run: |
          set -e

          rm -rf deploy_fe
          mkdir -p deploy_fe

          # standaloneì´ ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ë°”ë¡œ ì‹¤íŒ¨(ì›ì¸ ëª…í™•íˆ)
          if [ ! -d ".next/standalone" ]; then
            echo "ERROR: .next/standalone not found."
            echo "=> next.config.* ì— output: 'standalone' ì„¤ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ."
            exit 1
          fi

          # standalone ì„œë²„ ì‹¤í–‰ íŒŒì¼ + í•„ìš”í•œ node_modules í¬í•¨
          cp -r .next/standalone/. deploy_fe/

          # ì •ì  íŒŒì¼(í•„ìˆ˜)
          mkdir -p deploy_fe/.next
          cp -r .next/static deploy_fe/.next/static

          # public (ì‚¬ìš©í•˜ë©´ í¬í•¨)
          if [ -d "public" ]; then
            cp -r public deploy_fe/public
          fi

          # ëŸ°íƒ€ì„ì—ì„œ í•„ìš”í•˜ë©´ í¬í•¨(ì„ íƒ)
          cp package.json deploy_fe/package.json

          tar -czf "${{ env.ARTIFACT_FILE }}" -C deploy_fe .

      - name: Upload bundle to server (SCP)
        if: github.event_name == 'push' && github.ref_name == 'main'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.FRONT_PROD_SERVER_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: ${{ env.ARTIFACT_FILE }}
          target: ${{ env.REMOTE_DIR }}/incoming/

  deploy:
    name: CD (prod deploy)
    runs-on: ubuntu-latest
    needs: [ci]
    if: github.event_name == 'push' && github.ref_name == 'main' && needs.ci.result == 'success'

    steps:
      - name: Deploy via SSH (run deploy.sh)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.FRONT_PROD_SERVER_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -e
            cd ${{ env.REMOTE_DIR }}

            echo "Artifact: ${{ env.REMOTE_DIR }}/incoming/${{ env.ARTIFACT_FILE }}"

            chmod +x deploy.sh
            ./deploy.sh "${{ env.REMOTE_DIR }}/incoming/${{ env.ARTIFACT_FILE }}"

  notify:
    name: Notify Discord
    runs-on: ubuntu-latest
    needs: [ci, deploy]
    if: always()

    steps:
      - name: Send notification
        run: |
          CI_RESULT="${{ needs.ci.result }}"
          DEPLOY_RESULT="${{ needs.deploy.result }}"
          REF="${{ github.repository }}@${{ github.ref_name }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"username\":\"Frontend CI/CD\",\"content\":\"ğŸ–¥ï¸ Frontend CI/CD ê²°ê³¼\\n- CI: **${CI_RESULT}**\\n- Deploy: **${DEPLOY_RESULT}**\\nğŸ”— [${REF}](${RUN_URL})\"}" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}